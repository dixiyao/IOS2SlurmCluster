<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Remote Agent</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0a0a0a; color: #e0e0e0; height: 100vh; display: flex; flex-direction: column; }

  /* Connect screen */
  #connect-screen { display: flex; flex: 1; align-items: center; justify-content: center; }
  #connect-screen button {
    padding: 16px 48px; font-size: 18px; border: none; border-radius: 12px;
    background: #5865f2; color: #fff; cursor: pointer; transition: background 0.2s;
  }
  #connect-screen button:hover { background: #4752c4; }
  #connect-screen button:disabled { background: #444; cursor: wait; }

  /* Chat screen */
  #chat-screen { display: none; flex: 1; flex-direction: column; max-width: 800px; margin: 0 auto; width: 100%; }
  #header { padding: 12px 16px; border-bottom: 1px solid #222; display: flex; align-items: center; justify-content: space-between; }
  #header h2 { font-size: 16px; font-weight: 600; }
  #header .status { font-size: 12px; color: #4ade80; }
  #disconnect-btn { background: none; border: 1px solid #555; color: #aaa; padding: 4px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }

  #messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
  .msg { max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
  .msg.user { align-self: flex-end; background: #5865f2; color: #fff; border-bottom-right-radius: 4px; }
  .msg.agent { align-self: flex-start; background: #1e1e1e; border: 1px solid #333; border-bottom-left-radius: 4px; }
  .msg.system { align-self: center; color: #888; font-size: 12px; font-style: italic; }
  .msg.error { align-self: center; color: #f87171; font-size: 12px; }
  .typing { align-self: flex-start; color: #888; font-size: 13px; padding: 8px 14px; }

  #input-bar { padding: 12px 16px; border-top: 1px solid #222; display: flex; gap: 8px; }
  #input-bar textarea {
    flex: 1; background: #1e1e1e; border: 1px solid #333; border-radius: 10px;
    color: #e0e0e0; padding: 10px 14px; font-size: 14px; resize: none;
    font-family: inherit; outline: none; min-height: 44px; max-height: 120px;
  }
  #input-bar textarea:focus { border-color: #5865f2; }
  #send-btn {
    padding: 10px 20px; background: #5865f2; color: #fff; border: none;
    border-radius: 10px; cursor: pointer; font-size: 14px; align-self: flex-end;
  }
  #send-btn:disabled { background: #444; cursor: not-allowed; }
</style>
</head>
<body>

<div id="connect-screen">
  <button id="connect-btn" onclick="connect()">Connect to Server</button>
</div>

<div id="chat-screen">
  <div id="header">
    <div>
      <h2>Remote Agent</h2>
      <span class="status" id="status-text">Connected</span>
    </div>
    <button id="disconnect-btn" onclick="disconnect()">Disconnect</button>
  </div>
  <div id="messages"></div>
  <div id="input-bar">
    <textarea id="input" placeholder="Type a message..." rows="1" onkeydown="handleKey(event)"></textarea>
    <button id="send-btn" onclick="send()">Send</button>
  </div>
</div>

<script>
let ws = null;
let waiting = false;

function connect() {
  const btn = document.getElementById("connect-btn");
  btn.textContent = "Connecting...";
  btn.disabled = true;

  ws = new WebSocket(`ws://${location.host}`);

  ws.onopen = () => {
    ws.send(JSON.stringify({ type: "connect" }));
  };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);

    if (msg.type === "connected") {
      document.getElementById("connect-screen").style.display = "none";
      document.getElementById("chat-screen").style.display = "flex";
      addMsg("Connected to remote agent.", "system");
    }

    if (msg.type === "response") {
      removeTyping();
      waiting = false;
      addMsg(msg.content, "agent");
      document.getElementById("send-btn").disabled = false;
    }

    if (msg.type === "error") {
      removeTyping();
      waiting = false;
      addMsg(msg.content, "error");
      document.getElementById("send-btn").disabled = false;
    }

    if (msg.type === "disconnected") {
      addMsg("Disconnected from server.", "system");
      document.getElementById("status-text").textContent = "Disconnected";
      document.getElementById("status-text").style.color = "#f87171";
    }
  };

  ws.onclose = () => {
    btn.textContent = "Connect to Server";
    btn.disabled = false;
  };

  ws.onerror = () => {
    btn.textContent = "Connect to Server";
    btn.disabled = false;
    alert("WebSocket connection failed.");
  };
}

function disconnect() {
  if (ws) {
    ws.send(JSON.stringify({ type: "disconnect" }));
    ws.close();
  }
  document.getElementById("chat-screen").style.display = "none";
  document.getElementById("connect-screen").style.display = "flex";
}

function send() {
  const input = document.getElementById("input");
  const text = input.value.trim();
  if (!text || waiting) return;

  addMsg(text, "user");
  ws.send(JSON.stringify({ type: "message", content: text }));
  input.value = "";
  input.style.height = "44px";
  waiting = true;
  document.getElementById("send-btn").disabled = true;
  showTyping();
}

function handleKey(e) {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    send();
  }
  // Auto-resize
  setTimeout(() => {
    e.target.style.height = "44px";
    e.target.style.height = Math.min(e.target.scrollHeight, 120) + "px";
  }, 0);
}

function addMsg(text, cls) {
  const messages = document.getElementById("messages");
  const div = document.createElement("div");
  div.className = "msg " + cls;
  div.textContent = text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function showTyping() {
  const messages = document.getElementById("messages");
  const div = document.createElement("div");
  div.className = "typing";
  div.id = "typing-indicator";
  div.textContent = "Agent is thinking...";
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function removeTyping() {
  const el = document.getElementById("typing-indicator");
  if (el) el.remove();
}
</script>
</body>
</html>
